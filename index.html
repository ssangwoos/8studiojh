<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì—ì´íŠ¸ìŠ¤íŠœë””ì˜¤ì£¼í™© ì˜ˆì•½ í˜„í™©</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div id="add-booking-btn-container">
        <button id="add-booking-btn" onclick="openBookingModal()">â• ì˜ˆì•½ë“±ë¡</button>
    </div>

    <div class="container">
        <h1>ğŸŠ ì—ì´íŠ¸ìŠ¤íŠœë””ì˜¤ì£¼í™© ì˜ˆì•½ í˜„í™© ğŸŠ</h1>

        <div class="section date-picker-section">
            <label for="date-picker">ë‚ ì§œ ì„ íƒ:</label>
            <input type="date" id="date-picker">
            <button onclick="fetchBookings()">ì¡°íšŒ</button>
        </div>

        <div id="loading">ğŸ”„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</div>

        <div class="section" id="today-section" style="display: none;">
            <h2><span id="selected-date-label"></span> (<span id="selected-dow-label"></span>) ì˜¤ëŠ˜ ì´ìš© ëª©ë¡</h2>
            <ul id="today-list"></ul>
        </div>
        <div class="section" id="tomorrow-section" style="display: none;">
            <h2><span id="next-date-label"></span> (<span id="next-dow-label"></span>) ë‚´ì¼ ì´ìš© ëª©ë¡</h2>
            <ul id="tomorrow-list"></ul>
        </div>

        <div id="booking-details" style="display: none;">
            <h3>ì„ íƒëœ ì˜ˆì•½ ìƒì„¸ ì •ë³´</h3>
            <p><strong>ì˜ˆì•½ìëª…:</strong> <span id="detail-name"></span></p>
            <p><strong>ì—°ë½ì²˜:</strong> <span id="detail-phone"></span></p>
            <p><strong>ì´ìš©ì¼:</strong> <span id="detail-date"></span> (<span id="detail-dow"></span>)</p>
            <p><strong>ì´ìš©ì‹œê°„:</strong> <span id="detail-start-time"></span> ~ <span id="detail-end-time"></span> (<span id="detail-duration"></span>)</p>
            <p><strong>ì´ìš©ì¸ì›:</strong> <span id="detail-people"></span></p>
            <p><strong>ì´¬ì˜ìš©ë„:</strong> <span id="detail-purpose"></span></p>
            <p><strong>ì´ì•¡:</strong> <span id="detail-amount"></span></p>
            <p><strong>ì˜ˆì•½ì‚¬ì´íŠ¸:</strong> <span id="detail-site"></span></p>
            <div id="detail-actions">
                 <button id="btn-confirm-guide">ì˜ˆì•½í™•ì •ì•ˆë‚´</button>
                 <button id="btn-tomorrow-guide">ë‚´ì¼ì´ìš©ì•ˆë‚´</button>
                 <button id="btn-complete-guide">ì´ìš©ì™„ë£Œì•ˆë‚´</button>
            </div>
        </div>

        <div id="message-output-section" class="section" style="display: none;">
            <h3>ìƒì„±ëœ ì•ˆë‚´ë¬¸</h3>
            <textarea id="message-output-area" rows="15" readonly></textarea>
            <div style="text-align: right; margin-top: 10px;">
                 <button id="copy-message-button" onclick="copyGeneratedMessage()">ì•ˆë‚´ë¬¸ ë³µì‚¬</button>
                 <span id="copy-feedback-msg"></span>
            </div>
        </div>
    </div>

    <div id="booking-modal-overlay" class="modal-overlay">
        <div class="modal-content">
            <h3>ğŸ“ ì‹ ê·œ ì˜ˆì•½ ë“±ë¡</h3>
            <form id="booking-form">
                <div class="form-group"><label for="modal-name">ì˜ˆì•½ìëª…:</label><input type="text" id="modal-name" required></div>
                <div class="form-group"><label for="modal-phone">ì—°ë½ì²˜:</label><input type="tel" id="modal-phone" placeholder="010-xxxx-xxxx" required></div>
                <div class="form-group"><label for="modal-date">ì´ìš©ì¼:</label><input type="date" id="modal-date" required></div>
                <div class="form-group time-input-container">
                    <label>ì‹œì‘ì‹œê°„:</label>
                    <div class="time-select-wrapper">
                        <select id="modal-start-hour" required></select> <span>ì‹œ</span>
                        <select id="modal-start-minute" required><option value="00">00</option><option value="30">30</option></select> <span>ë¶„</span>
                    </div>
                </div>
                <div class="form-group time-input-container">
                    <label>ì¢…ë£Œì‹œê°„:</label>
                    <div class="time-select-wrapper">
                        <select id="modal-end-hour" required></select> <span>ì‹œ</span>
                        <select id="modal-end-minute" required><option value="00">00</option><option value="30">30</option></select> <span>ë¶„</span>
                    </div>
                </div>
                <div class="form-group"><label for="modal-people">ì´ìš©ì¸ì›:</label><input type="number" id="modal-people" min="1" required></div>
                <div class="form-group"><label for="modal-purpose">ì´¬ì˜ìš©ë„:</label><input type="text" id="modal-purpose"></div>
                <div class="form-group"><label for="modal-amount">ì´ì•¡:</label><input type="number" id="modal-amount" min="0" placeholder="ìˆ«ìë§Œ ì…ë ¥"></div>
                <div class="form-group">
                    <label for="modal-site">ì˜ˆì•½ì‚¬ì´íŠ¸:</label>
                    <select id="modal-site">
                        <option value="">ì„ íƒí•˜ì„¸ìš”</option><option value="í™ˆí˜ì´ì§€">í™ˆí˜ì´ì§€</option><option value="ë„¤ì´ë²„í”Œë ˆì´ìŠ¤">ë„¤ì´ë²„í”Œë ˆì´ìŠ¤</option><option value="ì¸ìŠ¤íƒ€">ì¸ìŠ¤íƒ€</option><option value="ì•„ì›Œí”Œë ˆì´ìŠ¤">ì•„ì›Œí”Œë ˆì´ìŠ¤</option><option value="ìŠ¤í˜ì´ìŠ¤í´ë¼ìš°ë“œ">ìŠ¤í˜ì´ìŠ¤í´ë¼ìš°ë“œ</option><option value="ë„¤ì´ë²„ìŠ¤í† ì–´íŒœ">ë„¤ì´ë²„ìŠ¤í† ì–´íŒœ</option><option value="ë³„ë„ë¬¸ì˜">ë³„ë„ë¬¸ì˜</option>
                    </select>
                </div>
                <div class="modal-actions">
                    <button type="button" class="cancel-btn" onclick="closeBookingModal()">ì·¨ì†Œ</button>
                    <button type="submit">ë“±ë¡</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…
        // !!! ì—¬ê¸°ì— Google Apps Script ì›¹ ì•± URLì„ ì •í™•íˆ ë¶™ì—¬ë„£ìœ¼ì„¸ìš” !!!
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxR_c6yX2cUp9TZ5Xr4b0w6-h-JQh1VJwhyskqlVs8FW1Zpcc4T5QEKKFBazaNMMPrkSA/exec'; // <<<---------- ì—¬ê¸°!!!
        // â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…â˜…

        let currentBookingsData = {};
        let selectedListItem = null;
        let currentlyDisplayedBookingIndex = null;
        let currentlyDisplayedListType = null;

        document.addEventListener('DOMContentLoaded', () => {
            try {
                const today = new Date();
                const todayStr = formatDateForInput(today);
                document.getElementById('date-picker').value = todayStr;
                document.getElementById('modal-date').value = todayStr;
                populateHourSelect('modal-start-hour');
                populateHourSelect('modal-end-hour');
                document.getElementById('booking-form').addEventListener('submit', handleBookingSubmit);
                console.log("í˜ì´ì§€ ë¡œë“œ ë° ë¦¬ìŠ¤ë„ˆ ì„¤ì • ì™„ë£Œ");
            } catch (error) { console.error("í˜ì´ì§€ ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜:", error); }
        });

        function populateHourSelect(selectId) {
            const selectElement = document.getElementById(selectId);
            if (!selectElement) return;
            selectElement.innerHTML = '';
            for (let i = 0; i <= 24; i++) {
                const hour = i.toString().padStart(2, '0');
                const option = new Option(hour, hour);
                selectElement.appendChild(option);
            }
        }

        function formatDateForInput(date) {
            try { const yyyy = date.getFullYear(); const mm = String(date.getMonth() + 1).padStart(2, '0'); const dd = String(date.getDate()).padStart(2, '0'); return `${yyyy}-${mm}-${dd}`; }
            catch(e) { console.error("formatDateForInput ì˜¤ë¥˜:", e); return ""; }
        }

        const display = (value) => (value !== null && value !== "" && value !== undefined) ? value : '-';

        function formatNumberWithCommas(number) {
            if (number === null || number === undefined || number === '' || isNaN(Number(number))) { return '-'; }
            return Number(number).toLocaleString('ko-KR');
        }

        async function fetchBookings() {
            console.log("'ì¡°íšŒ' ë²„íŠ¼ í´ë¦­ë¨");
            const selectedDate = document.getElementById('date-picker').value;
            if (!selectedDate) { alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.'); return; }
            showLoading(true);
            hideResultsAndDetails();
            try {
                const response = await fetch(`${WEB_APP_URL}?date=${selectedDate}`);
                if (!response.ok) { throw await generateErrorFromResponse(response, 'ì¡°íšŒ'); }
                const data = await response.json();
                if (data.status === 'error') { throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${data.message}`); }
                currentBookingsData = data;
                displayResults(data);
            } catch (error) {
                console.error('ì˜ˆì•½ ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                alert(`ì˜ˆì•½ ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:\n${error.message}\n(F12 ê°œë°œì ì½˜ì†” í™•ì¸)`);
            } finally {
                showLoading(false);
            }
        }

        function showLoading(isLoading) { try{ document.getElementById('loading').style.display = isLoading ? 'block' : 'none'; } catch(e){} }

        function hideResultsAndDetails() {
            try{ document.getElementById('today-section').style.display = 'none'; } catch(e){}
            try{ document.getElementById('tomorrow-section').style.display = 'none'; } catch(e){}
            try{ document.getElementById('booking-details').style.display = 'none'; } catch(e){}
            try{ document.getElementById('message-output-section').style.display = 'none'; } catch(e){}
            try{ document.getElementById('today-list').innerHTML = ''; } catch(e){}
            try{ document.getElementById('tomorrow-list').innerHTML = ''; } catch(e){}
            if (selectedListItem) { try{ selectedListItem.classList.remove('selected'); } catch(e){} selectedListItem = null; }
            currentlyDisplayedBookingIndex = null; currentlyDisplayedListType = null;
            try { document.getElementById('copy-feedback-msg').textContent = ''; } catch(e){}
        }

        function displayResults(data) {
            try {
                const todayList = document.getElementById('today-list');
                const tomorrowList = document.getElementById('tomorrow-list');
                document.getElementById('selected-date-label').textContent = data.selectedDate;
                document.getElementById('selected-dow-label').textContent = data.selectedDayOfWeek;
                document.getElementById('next-date-label').textContent = data.nextDate;
                document.getElementById('next-dow-label').textContent = data.nextDayOfWeek;
                todayList.innerHTML = ''; tomorrowList.innerHTML = '';
                if (!data.todayBookings || data.todayBookings.length === 0) { todayList.innerHTML = '<li>ì˜¤ëŠ˜ ì´ìš© ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; }
                else { data.todayBookings.forEach((b, i) => todayList.appendChild(createBookingListItem(b, 'today'))); } // index ì œê±°
                if (!data.tomorrowBookings || data.tomorrowBookings.length === 0) { tomorrowList.innerHTML = '<li>ë‚´ì¼ ì´ìš© ì˜ˆì•½ì´ ì—†ìŠµë‹ˆë‹¤.</li>'; }
                else { data.tomorrowBookings.forEach((b, i) => tomorrowList.appendChild(createBookingListItem(b, 'tomorrow'))); } // index ì œê±°
                document.getElementById('today-section').style.display = 'block';
                document.getElementById('tomorrow-section').style.display = 'block';
            } catch(e) { console.error("displayResults ì˜¤ë¥˜:", e); }
        }

        // === createBookingListItem í•¨ìˆ˜ ìˆ˜ì •: ì‚­ì œ ë²„íŠ¼ ì¶”ê°€ ===
        function createBookingListItem(booking, listType) { // index íŒŒë¼ë¯¸í„° ë¶ˆí•„ìš” ì‹œ ì œê±°
             const li = document.createElement('li');
             li.className = 'booking-item';

             const textSpan = document.createElement('span');
             textSpan.className = 'booking-item-text';
             textSpan.textContent = `${booking.startTime || 'ì‹œê°„ë¯¸ì •'} - ${booking.name || 'ì´ë¦„ì—†ìŒ'}`;
             li.appendChild(textSpan);

             li.dataset.listType = listType;
             li.dataset.rowIndex = booking.rowIndex; // booking ê°ì²´ì— rowIndexê°€ ìˆë‹¤ê³  ê°€ì •
             li.onclick = handleItemClick;

             const deleteBtn = document.createElement('button');
             deleteBtn.textContent = 'ì‚­ì œ';
             deleteBtn.className = 'delete-item-btn';
             deleteBtn.onclick = (event) => {
                 event.stopPropagation();
                 handleDeleteBookingClick(booking.rowIndex, booking.name, li);
             };
             li.appendChild(deleteBtn);

             return li;
        }

        function handleItemClick(event) {
            try {
                const clickedLi = event.currentTarget;
                const listType = clickedLi.dataset.listType;
                const rowIndex = clickedLi.dataset.rowIndex;
                let bookingData = null;
                const sourceList = (listType === 'today') ? currentBookingsData.todayBookings : currentBookingsData.tomorrowBookings;
                if (!sourceList) { console.error("Source list not found:", listType); return; }
                bookingData = sourceList.find(b => b.rowIndex && b.rowIndex.toString() === rowIndex.toString());
                if (!bookingData) { console.error("í´ë¦­ëœ ì˜ˆì•½ ë°ì´í„° ì°¾ê¸° ì‹¤íŒ¨.", listType, rowIndex); return; }
                const isAlreadyDisplayed = (currentlyDisplayedListType === listType && currentlyDisplayedBookingIndex && currentlyDisplayedBookingIndex.toString() === rowIndex.toString());
                const detailsSection = document.getElementById('booking-details');
                const messageSection = document.getElementById('message-output-section');
                if (isAlreadyDisplayed && detailsSection.style.display === 'block') {
                    detailsSection.style.display = 'none'; messageSection.style.display = 'none';
                    currentlyDisplayedBookingIndex = null; currentlyDisplayedListType = null;
                    if (selectedListItem) { selectedListItem.classList.remove('selected'); selectedListItem = null; }
                } else {
                    if (selectedListItem) { selectedListItem.classList.remove('selected'); }
                    clickedLi.classList.add('selected'); selectedListItem = clickedLi;
                    showBookingDetails(bookingData);
                    currentlyDisplayedBookingIndex = bookingData.rowIndex; currentlyDisplayedListType = listType;
                    messageSection.style.display = 'none'; try { document.getElementById('copy-feedback-msg').textContent = ''; } catch(e){}
                }
            } catch(e) { console.error("handleItemClick ì˜¤ë¥˜:", e); }
        }

        function showBookingDetails(booking) {
             try {
                 const peopleValue = booking.people; const peopleText = (peopleValue !== null && peopleValue !== "" && !isNaN(parseInt(peopleValue))) ? `${parseInt(peopleValue)}ì¸` : '-';
                 const amountText = formatNumberWithCommas(booking.amount);
                 document.getElementById('detail-name').textContent = display(booking.name);
                 document.getElementById('detail-phone').textContent = display(booking.phone);
                 document.getElementById('detail-date').textContent = display(booking.date);
                 document.getElementById('detail-dow').textContent = display(booking.dayOfWeek);
                 document.getElementById('detail-start-time').textContent = display(booking.startTime);
                 document.getElementById('detail-end-time').textContent = display(booking.endTime);
                 document.getElementById('detail-duration').textContent = display(booking.duration);
                 document.getElementById('detail-people').textContent = peopleText;
                 document.getElementById('detail-purpose').textContent = display(booking.purpose);
                 document.getElementById('detail-amount').textContent = amountText;
                 document.getElementById('detail-site').textContent = display(booking.site);
                 const confirmBtn = document.getElementById('btn-confirm-guide');
                 const tomorrowBtn = document.getElementById('btn-tomorrow-guide');
                 const completeBtn = document.getElementById('btn-complete-guide');
                 confirmBtn.onclick = () => handleConfirmGuideClick(booking);
                 tomorrowBtn.onclick = () => handleTomorrowGuideClick(booking);
                 completeBtn.onclick = () => handleCompleteGuideClick(booking);
                 document.getElementById('booking-details').style.display = 'block';
             } catch(e) { console.error("showBookingDetails ì˜¤ë¥˜:", e); }
        }

        function handleConfirmGuideClick(booking) {
            try {
                const pVal = booking.people; const pTxt = (pVal !== null && pVal !== "" && !isNaN(parseInt(pVal))) ? `${parseInt(pVal)}ì¸` : '-';
                const message = `<<ì˜ˆì•½í™•ì • ì•ˆë‚´>>\nì•ˆë…•í•˜ì„¸ìš” ${display(booking.name)}ë‹˜\nì—ì´íŠ¸ìŠ¤íŠœë””ì˜¤ ì£¼í™© ì…ë‹ˆë‹¤.\nì €í¬ ìŠ¤íŠœë””ì˜¤ë¥¼ ì„ íƒí•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤\nì˜ˆì•½í™•ì • ì•ˆë‚´ ë§ì”€ë“œë ¤ìš”:)\n\nâ–¡ì£¼ì†Œ : ê´‘ì§„êµ¬ ë©´ëª©ë¡œ182, ì¤‘ì•™ë¹Œë”© 301í˜¸\n\nâ–¡ ì „ì²´ëŒ€ê´€(Aë£¸&Bë£¸)\nâ–¡ì¼ì‹œ : ${display(booking.date)} (${display(booking.dayOfWeek)})\nì´ìš©ì‹œê°„ : ${display(booking.startTime)} - ${display(booking.endTime)} (${display(booking.duration)})\nì´ìš©ì¸ì› : ${pTxt}\nì‚¬ìš©ëª©ì  : ${display(booking.purpose)}\n\nâ–¡ ì´ìš©ì¼ 1ì¼ ì „ì— ì¶œì… ê´€ë ¨ ì•ˆë‚´ì‚¬í•­ì´ ë°œì†¡ ë  ì˜ˆì •ì…ë‹ˆë‹¤.\nâ–¡ì—°ë½ì²˜ : 010.7521.8806\nì¹´ì¹´ì˜¤í†¡ : @ì—ì´íŠ¸ìŠ¤íŠœë””ì˜¤ì£¼í™©\nì¸ìŠ¤íƒ€ : @studios_joohwang\n\nâ–¡ ê¸°ë³¸ ì´ìš©ì•ˆë‚´ ë° ìœ ì˜ì‚¬í•­ : https://vvd.bz/eVQd\nâ–¡ ì£¼ì°¨ ì•ˆë‚´ â—† 1ëŒ€ ë¬´ë£Œì£¼ì°¨ ê°€ëŠ¥í•˜ë©°, ê±´ë¬¼ ì „ìš©ì£¼ì°¨ì¥ ì´ìš©ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤. â—† ì£¼ì°¨ì¥ ë§Œì°¨ ì‹œ ì¸ê·¼ ê³µì˜ì£¼ì°¨ì¥ ì´ìš© ë¶€íƒë“œë¦¬ë©°, ë¹„ìš©ì„ ì „ì•¡(1ëŒ€) ì§€ì›í•´ ë“œë¦½ë‹ˆë‹¤.`;
                displayGeneratedMessage(message);
            } catch(e) { console.error("handleConfirmGuideClick ì˜¤ë¥˜:", e); }
        }

        function handleTomorrowGuideClick(booking) {
             try {
                const pVal = booking.people; const pTxt = (pVal !== null && pVal !== "" && !isNaN(parseInt(pVal))) ? `${parseInt(pVal)}ì¸` : '-';
                const dTxt = display(booking.duration);
                const message = `<<ì´ìš©ì•ˆë‚´>>\nì•ˆë…•í•˜ì„¸ìš” ${display(booking.name)}ë‹˜\nì—ì´íŠ¸ìŠ¤íŠœë””ì˜¤ ì£¼í™© ì…ë‹ˆë‹¤.\në‚´ì¼ ì´ìš© ì•ˆë‚´ì‚¬í•­ ë§ì”€ë“œë ¤ìš”:)\n\nâ–¡ì£¼ì†Œ : ê´‘ì§„êµ¬ ë©´ëª©ë¡œ182, ì¤‘ì•™ë¹Œë”© 301í˜¸\nâ–¡ì „ì²´ëŒ€ê´€(Aë£¸&Bë£¸)\nâ–¡ì¼ì‹œ : ${display(booking.date)} (${display(booking.dayOfWeek)})\nì´ìš©ì‹œê°„: ${display(booking.startTime)} - ${display(booking.endTime)} (${dTxt})\nì´ìš©ì¸ì›: ${pTxt}\nì‚¬ìš©ëª©ì : ${display(booking.purpose)}\n\nâ–¡ í˜„ê´€ ë¹„ë°€ë²ˆí˜¸ : 0654*\nâ–¡ Wifi ì•„ì´ë””/ë¹„ë°€ë²ˆí˜¸ : Studios_joohwang2.4G / joohwang0321\nâ–¡ì—°ë½ì²˜ : 010.7521.8806 ì¹´ì¹´ì˜¤í†¡ : @ì—ì´íŠ¸ìŠ¤íŠœë””ì˜¤ì£¼í™© ì¸ìŠ¤íƒ€ : @studios_joohwang\nâ–¡ ê¸°ë³¸ ì´ìš©ì•ˆë‚´ ë° ìœ ì˜ì‚¬í•­ : https://vvd.bz/eVQd\nâ–¡ìŠ¤íŠœë””ì˜¤ ì „ì²´ ê¸ˆì—° êµ¬ì—­ì…ë‹ˆë‹¤. í¡ì—°ì€ 1ì¸µ ì™¸ë¶€ì—ì„œ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\nâ–¡ ì£¼ì°¨ ì•ˆë‚´\nâ—† 1ëŒ€ ë¬´ë£Œì£¼ì°¨ ê°€ëŠ¥í•˜ë©°, ê±´ë¬¼ ì „ìš©ì£¼ì°¨ì¥ ì´ìš©ì„ ë¶€íƒë“œë¦½ë‹ˆë‹¤.\nâ—† ì£¼ì°¨ì¥ ë§Œì°¨ ì‹œ ì¸ê·¼ ê³µì˜ì£¼ì°¨ì¥ ì´ìš© ë¶€íƒë“œë¦¬ë©°, ë¹„ìš©ì„ ì „ì•¡(1ëŒ€) ì§€ì›í•´ ë“œë¦½ë‹ˆë‹¤.`;
                displayGeneratedMessage(message);
            } catch(e) { console.error("handleTomorrowGuideClick ì˜¤ë¥˜:", e); }
        }

        function handleCompleteGuideClick(booking) {
             try {
                const message = `ì•ˆë…•í•˜ì„¸ìš” ì—ì´íŠ¸ìŠ¤íŠœë””ì˜¤ ì£¼í™© ì…ë‹ˆë‹¤.\n\nê¸ˆì¼ ì´ìš©ì€ ì˜ í•˜ì…¨ëŠ”ì§€ìš”:)\në‹¤ìŒì—ë„ ì¢‹ì€ ì´¬ì˜ ë˜ì‹¤ ìˆ˜ ìˆëŠ” ê³µê°„ìœ¼ë¡œ\nê±°ë“­ë‚˜ë„ë¡ ë…¸ë ¥í•˜ê² ìŠµë‹ˆë‹¤.\n\nì €í¬ ìŠ¤íŠœë””ì˜¤ë¥¼ ë°©ë¬¸í•´ì£¼ì…”ì„œ ë‹¤ì‹œ í•œ ë²ˆ ê°ì‚¬ë“œë¦¬ê³ , ë‚¨ì€ í•˜ë£¨ í–‰ë³µí•œ ì‹œê°„ë˜ì„¸ìš”:)â¤`;
                displayGeneratedMessage(message);
            } catch(e) { console.error("handleCompleteGuideClick ì˜¤ë¥˜:", e); }
        }

        function displayGeneratedMessage(message) {
            try {
                const outputArea = document.getElementById('message-output-area');
                const outputSection = document.getElementById('message-output-section');
                outputArea.value = message; outputSection.style.display = 'block';
                document.getElementById('copy-feedback-msg').textContent = '';
                outputSection.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            } catch(e) { console.error("displayGeneratedMessage ì˜¤ë¥˜:", e); }
        }

        function copyGeneratedMessage() {
            const messageText = document.getElementById('message-output-area').value;
            const feedback = document.getElementById('copy-feedback-msg');
            feedback.textContent = '';
            if (navigator.clipboard && window.isSecureContext) {
                navigator.clipboard.writeText(messageText)
                    .then(() => { feedback.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ!'; setTimeout(() => { feedback.textContent = ''; }, 2000); })
                    .catch(err => { console.error('í´ë¦½ë³´ë“œ ë³µì‚¬ ì‹¤íŒ¨:', err); fallbackCopyTextToClipboard(messageText, feedback); });
            } else { fallbackCopyTextToClipboard(messageText, feedback); }
        }

        function fallbackCopyTextToClipboard(text, feedbackElement) {
             console.warn('Clipboard API ì‚¬ìš© ë¶ˆê°€ ë˜ëŠ” ì‹¤íŒ¨. Fallback ì‹œë„.');
             try {
                 const textArea = document.getElementById('message-output-area');
                 const wasReadOnly = textArea.readOnly; textArea.readOnly = false;
                 textArea.select(); textArea.setSelectionRange(0, 99999);
                 const successful = document.execCommand('copy');
                 if (successful) { feedbackElement.textContent = 'âœ… ë³µì‚¬ ì™„ë£Œ!'; setTimeout(() => { feedbackElement.textContent = ''; }, 2000); }
                 else { console.error('Fallback ë³µì‚¬ ëª…ë ¹ ì‹¤íŒ¨.'); feedbackElement.textContent = 'âŒ ë³µì‚¬ ì‹¤íŒ¨'; }
                 textArea.readOnly = wasReadOnly;
                 if (window.getSelection) { window.getSelection().removeAllRanges(); } else if (document.selection) { document.selection.empty(); }
             } catch (err) { console.error('Fallback ë³µì‚¬ ì˜¤ë¥˜:', err); feedbackElement.textContent = 'âŒ ë³µì‚¬ ì˜¤ë¥˜'; }
         }

        function openBookingModal() {
            console.log("ì˜ˆì•½ ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°");
            try { document.getElementById('modal-date').value = document.getElementById('date-picker').value || formatDateForInput(new Date()); } catch(e){}
            try { document.getElementById('booking-form').reset(); } catch(e){}
            try { document.getElementById('modal-date').value = document.getElementById('date-picker').value || formatDateForInput(new Date()); } catch(e){}
            try { document.getElementById('booking-modal-overlay').style.display = 'flex'; } catch(e){ console.error("ëª¨ë‹¬ ì—´ê¸° ì˜¤ë¥˜:", e);}
        }

        function closeBookingModal() {
            console.log("ì˜ˆì•½ ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸°");
            try{ document.getElementById('booking-modal-overlay').style.display = 'none'; } catch(e){}
        }

        // === ì˜ˆì•½ í¼ ì œì¶œ í•¨ìˆ˜ (ìˆ˜ì •: ì‚­ì œ ë²„íŠ¼ ê´€ë ¨ ì—†ìŒ) ===
        async function handleBookingSubmit(event) {
            event.preventDefault();
            console.log("ì˜ˆì•½ í¼ ì œì¶œë¨");
            let bookingData;
            try {
                const startHour = document.getElementById('modal-start-hour').value;
                const startMinute = document.getElementById('modal-start-minute').value;
                const endHour = document.getElementById('modal-end-hour').value;
                const endMinute = document.getElementById('modal-end-minute').value;
                const startTime = `${startHour}:${startMinute}`;
                const endTime = `${endHour}:${endMinute}`;
                const site = document.getElementById('modal-site').value;

                bookingData = {
                    name: document.getElementById('modal-name').value.trim(), phone: document.getElementById('modal-phone').value.trim(),
                    date: document.getElementById('modal-date').value, startTime: startTime, endTime: endTime,
                    people: document.getElementById('modal-people').value, purpose: document.getElementById('modal-purpose').value.trim(),
                    amount: document.getElementById('modal-amount').value, site: site
                };
                if (!bookingData.name || !bookingData.phone || !bookingData.date || !bookingData.startTime || !bookingData.endTime || !bookingData.people) {
                    alert('í•„ìˆ˜ ì…ë ¥ í•­ëª©(ì´ë¦„, ì—°ë½ì²˜, ë‚ ì§œ, ì‹œê°„, ì¸ì›)ì„ ëª¨ë‘ ì±„ì›Œì£¼ì„¸ìš”.'); return;
                }
                 if (endTime !== "00:00" && `${bookingData.date} ${endTime}` <= `${bookingData.date} ${startTime}`) {
                    if (!(endTime === "24:00" && startTime !== "24:00")) { // 24:00 ì¢…ë£ŒëŠ” í—ˆìš© (ë‹¤ìŒë‚  00ì‹œ)
                        alert('ì¢…ë£Œ ì‹œê°„ì€ ì‹œì‘ ì‹œê°„ë³´ë‹¤ ë¹ ë¥¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.\n(ìì • ë„˜ì–´ê°€ëŠ” ì˜ˆì•½ì€ ì¢…ë£Œì‹œê°„ 24:00 ë˜ëŠ” ë‹¤ìŒë‚  00:00 ì‚¬ìš©)'); return;
                    }
                 }
            } catch(formError) { console.error("í¼ ë°ì´í„° ìˆ˜ì§‘ ì˜¤ë¥˜:", formError); alert("í¼ ë°ì´í„°ë¥¼ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤."); return; }

            showLoading(true);
            try {
                const response = await fetch(`${WEB_APP_URL}?action=addBooking`, {
                    method: 'POST', cache: 'no-cache', body: JSON.stringify(bookingData), headers: {'Content-Type': 'text/plain;charset=utf-8'}
                });
                if (!response.ok) { throw await generateErrorFromResponse(response, 'ë“±ë¡'); }
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message || 'ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    closeBookingModal(); fetchBookings();
                } else { throw new Error(result.message || 'ë“±ë¡ ì‹¤íŒ¨ (ì„œë²„)'); }
            } catch (error) {
                console.error('ì˜ˆì•½ ë“±ë¡ ì‹¤íŒ¨:', error); alert(`ì˜ˆì•½ ë“±ë¡ ì¤‘ ì˜¤ë¥˜:\n${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        // === ì˜ˆì•½ ì‚­ì œ í•¨ìˆ˜ ===
        async function handleDeleteBookingClick(rowIndex, bookingName, listItemElement) {
            console.log(`ì‚­ì œ ìš”ì²­: í–‰ ${rowIndex}, ì´ë¦„ ${bookingName}`);
            if (!confirm(`"${bookingName}"ë‹˜ì˜ ì˜ˆì•½ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‹œíŠ¸ì™€ ì—°ê²°ëœ ìº˜ë¦°ë” ì¼ì •ì´ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.)`)) {
                return;
            }
            showLoading(true);
            try {
                const payload = { action: 'deleteBooking', rowIndex: rowIndex };
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST', cache: 'no-cache', body: JSON.stringify(payload), headers: {'Content-Type': 'text/plain;charset=utf-8'}
                });
                if (!response.ok) { throw await generateErrorFromResponse(response, 'ì‚­ì œ'); }
                const result = await response.json();
                if (result.status === 'success') {
                    alert(result.message || 'ì˜ˆì•½ì´ ì„±ê³µì ìœ¼ë¡œ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    listItemElement.remove();
                    if (currentlyDisplayedBookingIndex && currentlyDisplayedBookingIndex.toString() === rowIndex.toString()) {
                        document.getElementById('booking-details').style.display = 'none';
                        document.getElementById('message-output-section').style.display = 'none';
                        currentlyDisplayedBookingIndex = null; currentlyDisplayedListType = null;
                    }
                } else { throw new Error(result.message || 'ì‚­ì œ ì‹¤íŒ¨ (ì„œë²„)'); }
            } catch (error) {
                console.error('ì˜ˆì•½ ì‚­ì œ ì‹¤íŒ¨:', error); alert(`ì˜ˆì•½ ì‚­ì œ ì¤‘ ì˜¤ë¥˜:\n${error.message}`);
            } finally {
                showLoading(false);
            }
        }

        async function generateErrorFromResponse(response, actionPrefix) {
            let errorText = `${actionPrefix} ì¤‘ ì„œë²„ ì˜¤ë¥˜! ìƒíƒœ: ${response.status}`;
            try {
                const text = await response.text(); console.error(`ì„œë²„ ${actionPrefix} ì‘ë‹µ:`, text);
                if (text.toLowerCase().includes("script function not found")) { errorText += `\nì˜¤ë¥˜: Apps Script í•¨ìˆ˜ ë¬¸ì œ ë˜ëŠ” ë°°í¬ ì˜¤ë¥˜.`; }
                else if (text.toLowerCase().includes("unexpected error while getting the method or property appendrow")) { errorText += `\nì˜¤ë¥˜: ì‹œíŠ¸ ì“°ê¸° ê¶Œí•œ ë˜ëŠ” ë°ì´í„° í˜•ì‹ ë¬¸ì œ.`;}
                else if (text.length < 300) { errorText += `\nì‘ë‹µ: ${text}`; }
            } catch (e) {}
            return new Error(errorText);
        }
    </script>
</body>
</html>